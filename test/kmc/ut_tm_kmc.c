/* Copyright (C) 2009 - 2022 National Aeronautics and Space Administration.
   All Foreign Rights are Reserved to the U.S. Government.

   This software is provided "as is" without any warranty of any kind, either expressed, implied, or statutory,
   including, but not limited to, any warranty that the software will conform to specifications, any implied warranties
   of merchantability, fitness for a particular purpose, and freedom from infringement, and any warranty that the
   documentation will conform to the program, or any warranty that the software will be error free.

   In no event shall NASA be liable for any damages, including, but not limited to direct, indirect, special or
   consequential damages, arising out of, resulting from, or in any way connected with the software or its
   documentation, whether or not based upon warranty, contract, tort or otherwise, and whether or not loss was sustained
   from, or arose out of the results of, or use of, the software, documentation or services provided hereunder.

   ITC Team
   NASA IV&V
   jstar-development-team@mail.nasa.gov
*/

/**
 *  Unit Tests that make use of TM Functionality with KMC Service.
 **/

#include "ut_tm_apply.h"
#include "ut_tm_process.h"
#include "crypto.h"
#include "crypto_error.h"
#include "sa_interface.h"
#include "utest.h"

#include <mysql/mysql.h>
#include <stdlib.h>

#define KMC_HOSTNAME           "itc.kmc.nasa.gov"
#define CA_PATH                "/home/jstar/Desktop/kmc_certs/ca.pem"
#define CLIENT_CERTIFICATE     "/home/jstar/Desktop/kmc_certs/ammos-client-cert.pem"
#define CLIENT_CERTIFICATE_KEY "/home/jstar/Desktop/kmc_certs/ammos-client-key.pem"

void reload_db(void)
{
    printf("Resetting Database\n");
    system("mysql --host=localhost -u cryptosvc --skip-ssl-verify-server-cert "
           "--ssl-ca=/home/jstar/Desktop/kmc_certs/ca.pem "
           "--ssl-cert=/home/jstar/Desktop/kmc_certs/ammos-server-cert.pem "
           "--ssl-key=/home/jstar/Desktop/kmc_certs/ammos-server-key.pem < "
           "src/sa/sadb_mariadb_sql/empty_sadb_tm.sql");
    printf("first call done\n");
    system("mysql --host=localhost -u cryptosvc --skip-ssl-verify-server-cert "
           "--ssl-ca=/home/jstar/Desktop/kmc_certs/ca.pem  "
           "--ssl-cert=/home/jstar/Desktop/kmc_certs/ammos-server-cert.pem "
           "--ssl-key=/home/jstar/Desktop/kmc_certs/ammos-server-key.pem < "
           "src/sa/test_sadb_mariadb_sql/create_sadb_ivv_tm_unit_tests.sql");
}


/**
 * @brief MariaDB: Table Cleanup for Unit Tests
 * Be sure to use only after initialization
 * TODO: Move to shared function for all Unit Tests
 */
void MDB_DB_RESET()
{
    MYSQL *con = mysql_init(NULL);
    if (sa_mariadb_config->mysql_mtls_key != NULL)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_KEY, sa_mariadb_config->mysql_mtls_key);
    }
    if (sa_mariadb_config->mysql_mtls_cert != NULL)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_CERT, sa_mariadb_config->mysql_mtls_cert);
    }
    if (sa_mariadb_config->mysql_mtls_ca != NULL)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_CA, sa_mariadb_config->mysql_mtls_ca);
    }
    if (sa_mariadb_config->mysql_mtls_capath != NULL)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_CAPATH, sa_mariadb_config->mysql_mtls_capath);
    }
    if (sa_mariadb_config->mysql_tls_verify_server != CRYPTO_FALSE)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_VERIFY_SERVER_CERT, &(sa_mariadb_config->mysql_tls_verify_server));
    }
    if (sa_mariadb_config->mysql_mtls_client_key_password != NULL)
    {
        mysql_optionsv(con, MARIADB_OPT_TLS_PASSPHRASE, sa_mariadb_config->mysql_mtls_client_key_password);
    }
    if (sa_mariadb_config->mysql_require_secure_transport == CRYPTO_TRUE)
    {
        mysql_optionsv(con, MYSQL_OPT_SSL_ENFORCE, &(sa_mariadb_config->mysql_require_secure_transport));
    }
    // if encrypted connection (TLS) connection. No need for SSL Key
    if (mysql_real_connect(con, sa_mariadb_config->mysql_hostname, sa_mariadb_config->mysql_username,
                           sa_mariadb_config->mysql_password, sa_mariadb_config->mysql_database,
                           sa_mariadb_config->mysql_port, NULL, 0) == NULL)
    {
        // 0,NULL,0 are port number, unix socket, client flag
        //finish_with_error(con);
    }

    printf("Truncating Tables\n");
    char *query = "TRUNCATE TABLE security_associations_tm\n";
    if (mysql_real_query(con, query, strlen(query)))
    { // query should be NUL terminated!
        printf("Failed to Truncate Table\n");
        //finish_with_error(con);
    }
    query =
        "INSERT INTO security_associations_tm "
        "(spi,ekid,sa_state,ecs,est,ast,shivf_len,iv_len,stmacf_len,iv,abm_len,abm,arsnw,arsn_len,tfvn,scid,vcid,mapid,"
        "ecs_len, shplf_len) VALUES "
        "(11,'kmc/test/"
        "key130',3,X'02',1,0,16,16,0,X'00000000000000000000000000000001',1024,X'"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000',5,0,0,3,0,0,1,1)";
    if (mysql_real_query(con, query, strlen(query)))
    { // query should be NUL terminated!
        printf("Failed to re-create security_association_tm table for SPI 11\n");
        //finish_with_error(con);
    }
}

/**
 * @brief Unit Test: Nominal Encryption CBC KMC
 **/
UTEST(TM_APPLY_KMC, HAPPY_PATH_ENC_TM_GCM_KMC)
{
    remove("sa_save_file.bin");
    reload_db();
    // Setup & Initialize CryptoLib
    Crypto_Config_CryptoLib(KEY_TYPE_KMC, MC_TYPE_DISABLED, SA_TYPE_MARIADB, CRYPTOGRAPHY_TYPE_KMCCRYPTO,
                            IV_CRYPTO_MODULE, CRYPTO_TC_CREATE_FECF_TRUE, TC_PROCESS_SDLS_PDUS_TRUE, TC_HAS_PUS_HDR,
                            TC_IGNORE_SA_STATE_FALSE, TC_IGNORE_ANTI_REPLAY_TRUE, TC_UNIQUE_SA_PER_MAP_ID_FALSE,
                            TC_CHECK_FECF_TRUE, 0x3F, SA_INCREMENT_NONTRANSMITTED_IV_TRUE);
    Crypto_Config_MariaDB(KMC_HOSTNAME, "sadb", 3306, CRYPTO_TRUE, CRYPTO_TRUE, CA_PATH, NULL, CLIENT_CERTIFICATE,
                          CLIENT_CERTIFICATE_KEY, "changeit", "cryptosvc", NULL);
    Crypto_Config_Kmc_Crypto_Service("https", "itc.kmc.nasa.gov", 8443, "crypto-service",
                                     "/home/jstar/Desktop/kmc_certs/ca.pem", NULL, CRYPTO_TRUE, CLIENT_CERTIFICATE,
                                     "PEM", CLIENT_CERTIFICATE_KEY, NULL, NULL);
    GvcidManagedParameters_t TM_UT_Managed_Parameters = {
        0, 0x0003, 1, TM_HAS_FECF, AOS_FHEC_NA, AOS_IZ_NA, 0, TM_SEGMENT_HDRS_NA, 1786, TM_NO_OCF, 1};
    Crypto_Config_Add_Gvcid_Managed_Parameters(TM_UT_Managed_Parameters);

    int32_t return_val = Crypto_Init();
    ASSERT_EQ(CRYPTO_LIB_SUCCESS, return_val);

    char *raw_tm_sdls_ping_h =
        "003200001800000008010000000F00112233445566778899AABBCCDDEEFFA107FF000006D2ABBABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAA"
        "BBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB"
        "AABBAABBAABBAABB00000000000000000000000000000000415B";
    char *raw_tm_sdls_ping_b      = NULL;
    int raw_tm_sdls_ping_len = 0;
    // SaInterface sa_if = get_sa_interface_inmemory();

    hex_conversion(raw_tm_sdls_ping_h, &raw_tm_sdls_ping_b, &raw_tm_sdls_ping_len);

    return_val =
        Crypto_TM_ApplySecurity((uint8_t *)raw_tm_sdls_ping_b, raw_tm_sdls_ping_len);
    ASSERT_EQ(CRYPTO_LIB_SUCCESS, return_val);

    char *truth_tm_h = "003200001800000300000000000000000000000100EAD4B927F61B18F2771E0B23EE8217F27CC1A30B55347164A4502599E66ED481B8D430CA8B102CD1547E4EF8E88C000A0D20ABADCA6F1EA3933AFB043EBB62E4C2E17FAF7C09DD0A94C4CDE0E382F66B295807F39B6D9317619D2649C96DB7ACC6EFBF3334BDCCEB0A969D2E920BC5FDA9137BDD41F49A0276544B0F4968997A505AE22A1AA4E9FF55641F04140B3445B7A063AFBB83E12A81CDFA46074DD0DB9FC86B6F67879E744458A39191AE34FC5F8B7266077D026DEFA995B9C8A8514D95992E6991C71EFEECA6DB5F8E9EA5E6C66204B7F9F2E2237640E9944258FCF9686B46A6E16DC9A0420428A14B6EEFE5619975956D2FAFCEB747C7352850E17A30023842AB33A4F9E2FD6168E187C3B730C38EE1734056C23B6D1E755EB446B61476468E01C570D5089B271C1AA3270F0488422B5A78E9BCD9EB75065F0183A887AD10A96542FF45F870C05AF113EF6C35AF298E983C5D7876A801C741D27EB742ABE305F82DACC902E9169C425212AB9ED684DAA3383B661E8848E71CD1FC050264AAFA97FC188DD0FADCF7599A800419A6302D8BA0257F5A81C5A8BB9FBF13FD9A9BA45846218DF0377EC91816F4A07550DF1B8A3B5057B3994426799466C7D8EFDEC8F8E495FD971B367795776ABF344BAD1DA919EC794FB84CD97AEDFD8FD1FB243B206CDE9BB468A1657D9A4248E7F0AA5990ABD085B7C8A2990816730D9FD74EE0BA70A7CDCB2AD8A16074EBF09BAB1F958DD18A8D9AABA4872D9FA944362CD70A5596D94D0AA99852BFEEEE19921943FF165A7CDE60057C39A5BA200B152772F8FD4935537442AF492BE09F3D063B00958F61B5905E9BAEEF940E0607A07577100382070CC55EEC0E3408AB93E9A30689115FEC0E3357732DE89D83232C313B6F0EE2B6FE315B638DA0FBE7E3F07EDD09ED1937C71C002B06C0ADE996570B1F68A4C1B8B2891DDC6162567C520435FF4F4EFB1A2B9E126E4F84302FD2C2EAA15DB58B24C88ACC33BD50041742AC9A64E9D2DD171A1CD18AD173CCE9F2DD2D8CE02AB55B87D42FB227B08029446B32D85F419928DBB67549727A79BA4CEFC6C379D0DF238AE521C5217048FDB124A168836B4486E0F91ECDF76E4A32491D94C7860C8CE03C0B41447D6E703421A5B4D3D3578F1BC1EBEE99C49D577D2DC710DCDE1BE74C1308F0D85C6570A0C28DE14C0A1E3D0FD85D894F5CC0A0D0BC824426A7EF42EB8490D318FCB75251E63E4629C1966FDF5EE3920A7CFF380DBD89DC294AFF16361F55B0DA4724DB2771857670382A0AD329D02761C3523AD2B1336B5DE85848F7D70A280F65AA05A36A1C676AC9BF9BBA71ECC7C3482B4F2A92409392A4CE5401B56C9A007338FE518E55A9B8BBE4543EA4C6B1D9CADA9783B568B8AB0D9218F95F9898693C979BF0995041F0C754EF142D6521830405F5F67249BC5DD6F187D9AC281599CB3C6BEAA4519388E983B0DEF619C809EFC2C6C7ADA36FE06B0F12A41B2FF67C416A08D1BEF6069C5544B3C66B696BDE1A64CFF59646713C7C7CFC1335E64A1A75C8290A28527AA8C087E20256A44F257B7D1B224D94DF5F189E16B7DD2CCBD458260CCA0556CA1B13F28E87B96AE6BCF0701B40BAF68B95285CFCBBB65A70BD02F4B846168EB3950AC772DCA4DB620427125944BFAF3651359E6CF97572EDB9ADD77EDF2E29DF00304ED7981965F549355BA8780909398FE6CE14B1A1D3304AB27745592F6EE62A7721900CC7326505C5D6EF9972DDDCA4472EE27E425002A283ADDAF57477ADE01329D9036ADE65298765665887342FB7653353F0C73418BD0FFBA466C6058835E4751AEE5FA275FFE5D3775C89935F1E1FC1C80D0174F8EFA87071834ADFA0EA59F7F9749AF9123E10ED01B72C8C68D6E4F58BEFE7D52B7C774C84E8C6F57BBDCA9EA2E7197FABE47A2058D3750A5BEADCB883D9288A804FF3C32E9CBC26132A5F51D16E2250EE2186E34C329D783D4E907F039A833B18358CDB0EF1AB5A0F66B5FDDCD42603B4DF499C799C02261072B834976DA5F0C50ECFC5DF355C943FC0C2E06C59B15830862E5C9E25091BE659A7D383090EEBD22C3FFFB6AD80F882FB38F4E3689821D9A058E4569D14E48E6BDB9F973AA26A4B1B683CDF0AE5F67CA93CD0519622DC9E17884657637629E2F0507683BD9E9B80423A6E8220000CE924E2B71AA3025118C7AFD578A1DB0BC7243D6F7FB839223FDB02DE3973B9D954625A11A321D9FFFB01EC1EF3AD73F6215FDC51F45A9C39D69F5D55EAE424B3E48EDE3C5A5B441EA4BF6BF578A3AB8CCD19D650742B514C4ABEC1D766D9C1A52895D93E6A905DBB1898409D60CA9CC82F03D0E2FEEB542D12B00F3E229CCDC41C5D6DCDED6A23B6CDEFBFB0C77904BB0F80C0EF2C73BBFDE8AE8E4DD6D13369F1D4CD1CC233ADE81EE90FD0B4AEAAF3DE619DBFAF431DA98731B1BC956B514759F75CCF0497561450560E01656399DDC34B0000";
    char *truth_tm_b   = NULL;
    int   truth_tm_len = 0;
    hex_conversion(truth_tm_h, &truth_tm_b, &truth_tm_len);

    for (int i = 0; i < tm_current_managed_parameters_struct.max_frame_size; i++)
    {
        // printf("Checking %02x against %02X\n", (uint8_t)raw_tm_sdls_ping_b[i], (uint8_t) * (truth_tm_b + i));
        ASSERT_EQ((uint8_t)raw_tm_sdls_ping_b[i], (uint8_t) * (truth_tm_b + i));
    }

    Crypto_Shutdown();
    free(raw_tm_sdls_ping_b);
}

/**
 * @brief Unit Test: Nominal Encryption CBC KMC
 **/
UTEST(TM_PROCESS_KMC, HAPPY_PATH_DEC_TM_GCM_KMC)
{
    remove("sa_save_file.bin");
    reload_db();
    // Setup & Initialize CryptoLib
    Crypto_Config_CryptoLib(KEY_TYPE_KMC, MC_TYPE_DISABLED, SA_TYPE_MARIADB, CRYPTOGRAPHY_TYPE_KMCCRYPTO,
                            IV_CRYPTO_MODULE, CRYPTO_TC_CREATE_FECF_TRUE, TC_PROCESS_SDLS_PDUS_TRUE, TC_HAS_PUS_HDR,
                            TC_IGNORE_SA_STATE_FALSE, TC_IGNORE_ANTI_REPLAY_TRUE, TC_UNIQUE_SA_PER_MAP_ID_FALSE,
                            TC_CHECK_FECF_TRUE, 0x3F, SA_INCREMENT_NONTRANSMITTED_IV_TRUE);
    Crypto_Config_MariaDB(KMC_HOSTNAME, "sadb", 3306, CRYPTO_TRUE, CRYPTO_TRUE, CA_PATH, NULL, CLIENT_CERTIFICATE,
                          CLIENT_CERTIFICATE_KEY, "changeit", "cryptosvc", NULL);
    Crypto_Config_Kmc_Crypto_Service("https", "itc.kmc.nasa.gov", 8443, "crypto-service",
                                     "/home/jstar/Desktop/kmc_certs/ca.pem", NULL, CRYPTO_TRUE, CLIENT_CERTIFICATE,
                                     "PEM", CLIENT_CERTIFICATE_KEY, NULL, NULL);
    GvcidManagedParameters_t TM_UT_Managed_Parameters = {
        0, 0x0003, 1, TM_HAS_FECF, AOS_FHEC_NA, AOS_IZ_NA, 0, TM_SEGMENT_HDRS_NA, 1786, TM_NO_OCF, 1};
    Crypto_Config_Add_Gvcid_Managed_Parameters(TM_UT_Managed_Parameters);

    int32_t return_val = Crypto_Init();
    ASSERT_EQ(CRYPTO_LIB_SUCCESS, return_val);

    char *raw_tm_sdls_ping_h =
        "003200001800000300000000000000000000000100EAD4B927F61B18F2771E0B23EE8217F27CC1A30B55347164A4502599E66ED481B8D430CA8B102CD1547E4EF8E88C000A0D20ABADCA6F1EA3933AFB043EBB62E4C2E17FAF7C09DD0A94C4CDE0E382F66B295807F39B6D9317619D2649C96DB7ACC6EFBF3334BDCCEB0A969D2E920BC5FDA9137BDD41F49A0276544B0F4968997A505AE22A1AA4E9FF55641F04140B3445B7A063AFBB83E12A81CDFA46074DD0DB9FC86B6F67879E744458A39191AE34FC5F8B7266077D026DEFA995B9C8A8514D95992E6991C71EFEECA6DB5F8E9EA5E6C66204B7F9F2E2237640E9944258FCF9686B46A6E16DC9A0420428A14B6EEFE5619975956D2FAFCEB747C7352850E17A30023842AB33A4F9E2FD6168E187C3B730C38EE1734056C23B6D1E755EB446B61476468E01C570D5089B271C1AA3270F0488422B5A78E9BCD9EB75065F0183A887AD10A96542FF45F870C05AF113EF6C35AF298E983C5D7876A801C741D27EB742ABE305F82DACC902E9169C425212AB9ED684DAA3383B661E8848E71CD1FC050264AAFA97FC188DD0FADCF7599A800419A6302D8BA0257F5A81C5A8BB9FBF13FD9A9BA45846218DF0377EC91816F4A07550DF1B8A3B5057B3994426799466C7D8EFDEC8F8E495FD971B367795776ABF344BAD1DA919EC794FB84CD97AEDFD8FD1FB243B206CDE9BB468A1657D9A4248E7F0AA5990ABD085B7C8A2990816730D9FD74EE0BA70A7CDCB2AD8A16074EBF09BAB1F958DD18A8D9AABA4872D9FA944362CD70A5596D94D0AA99852BFEEEE19921943FF165A7CDE60057C39A5BA200B152772F8FD4935537442AF492BE09F3D063B00958F61B5905E9BAEEF940E0607A07577100382070CC55EEC0E3408AB93E9A30689115FEC0E3357732DE89D83232C313B6F0EE2B6FE315B638DA0FBE7E3F07EDD09ED1937C71C002B06C0ADE996570B1F68A4C1B8B2891DDC6162567C520435FF4F4EFB1A2B9E126E4F84302FD2C2EAA15DB58B24C88ACC33BD50041742AC9A64E9D2DD171A1CD18AD173CCE9F2DD2D8CE02AB55B87D42FB227B08029446B32D85F419928DBB67549727A79BA4CEFC6C379D0DF238AE521C5217048FDB124A168836B4486E0F91ECDF76E4A32491D94C7860C8CE03C0B41447D6E703421A5B4D3D3578F1BC1EBEE99C49D577D2DC710DCDE1BE74C1308F0D85C6570A0C28DE14C0A1E3D0FD85D894F5CC0A0D0BC824426A7EF42EB8490D318FCB75251E63E4629C1966FDF5EE3920A7CFF380DBD89DC294AFF16361F55B0DA4724DB2771857670382A0AD329D02761C3523AD2B1336B5DE85848F7D70A280F65AA05A36A1C676AC9BF9BBA71ECC7C3482B4F2A92409392A4CE5401B56C9A007338FE518E55A9B8BBE4543EA4C6B1D9CADA9783B568B8AB0D9218F95F9898693C979BF0995041F0C754EF142D6521830405F5F67249BC5DD6F187D9AC281599CB3C6BEAA4519388E983B0DEF619C809EFC2C6C7ADA36FE06B0F12A41B2FF67C416A08D1BEF6069C5544B3C66B696BDE1A64CFF59646713C7C7CFC1335E64A1A75C8290A28527AA8C087E20256A44F257B7D1B224D94DF5F189E16B7DD2CCBD458260CCA0556CA1B13F28E87B96AE6BCF0701B40BAF68B95285CFCBBB65A70BD02F4B846168EB3950AC772DCA4DB620427125944BFAF3651359E6CF97572EDB9ADD77EDF2E29DF00304ED7981965F549355BA8780909398FE6CE14B1A1D3304AB27745592F6EE62A7721900CC7326505C5D6EF9972DDDCA4472EE27E425002A283ADDAF57477ADE01329D9036ADE65298765665887342FB7653353F0C73418BD0FFBA466C6058835E4751AEE5FA275FFE5D3775C89935F1E1FC1C80D0174F8EFA87071834ADFA0EA59F7F9749AF9123E10ED01B72C8C68D6E4F58BEFE7D52B7C774C84E8C6F57BBDCA9EA2E7197FABE47A2058D3750A5BEADCB883D9288A804FF3C32E9CBC26132A5F51D16E2250EE2186E34C329D783D4E907F039A833B18358CDB0EF1AB5A0F66B5FDDCD42603B4DF499C799C02261072B834976DA5F0C50ECFC5DF355C943FC0C2E06C59B15830862E5C9E25091BE659A7D383090EEBD22C3FFFB6AD80F882FB38F4E3689821D9A058E4569D14E48E6BDB9F973AA26A4B1B683CDF0AE5F67CA93CD0519622DC9E17884657637629E2F0507683BD9E9B80423A6E8220000CE924E2B71AA3025118C7AFD578A1DB0BC7243D6F7FB839223FDB02DE3973B9D954625A11A321D9FFFB01EC1EF3AD73F6215FDC51F45A9C39D69F5D55EAE424B3E48EDE3C5A5B441EA4BF6BF578A3AB8CCD19D650742B514C4ABEC1D766D9C1A52895D93E6A905DBB1898409D60CA9CC82F03D0E2FEEB542D12B00F3E229CCDC41C5D6DCDED6A23B6CDEFBFB0C77904BB0F80C0EF2C73BBFDE8AE8E4DD6D13369F1D4CD1CC233ADE81EE90FD0B4AEAAF3DE619DBFAF431DA98731B1BC956B514759F75CCF0497561450560E01656399DDC34B0000";
    char *raw_tm_sdls_ping_b      = NULL;
    int raw_tm_sdls_ping_len = 0;

    hex_conversion(raw_tm_sdls_ping_h, &raw_tm_sdls_ping_b, &raw_tm_sdls_ping_len);
    TM_t *tm_frame;
    tm_frame = malloc(sizeof(uint8_t) * TM_SIZE);
    memset(tm_frame, 0, (sizeof(uint8_t) * TM_SIZE));
    uint16_t processed_tm_len = 0;

    return_val =
        Crypto_TM_ProcessSecurity((uint8_t *)raw_tm_sdls_ping_b, raw_tm_sdls_ping_len, tm_frame, &processed_tm_len);
    ASSERT_EQ(CRYPTO_LIB_SUCCESS, return_val);
    
    char *truth_tm_h = "003200001800000000000000000000000000000066778899AABBCCDDEEFFA107FF000006D2ABBABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABBAABB000000000000000000000000000000000000";
    char *truth_tm_b   = NULL;
    int   truth_tm_len = 0;
    hex_conversion(truth_tm_h, &truth_tm_b, &truth_tm_len);
    SecurityAssociation_t *sa_ptr = NULL;
    sa_if->sa_get_from_spi(3, &sa_ptr);
    uint16_t offset = TM_FRAME_PRIMARYHEADER_SIZE + SPI_LEN + sa_ptr->shivf_len + sa_ptr->shsnf_len + sa_ptr->shplf_len;
    for (int i = 0; i < tm_frame->tm_pdu_len; i++)
    {
        // printf("Checking %02x against %02X\n", (uint8_t)raw_tm_sdls_ping_b[i], (uint8_t) * (truth_tm_b + i));
        ASSERT_EQ((uint8_t)tm_frame->tm_pdu[i], (uint8_t) * (truth_tm_b + i + offset));
    }

    Crypto_Shutdown();
    free(raw_tm_sdls_ping_b);
}

UTEST_MAIN();